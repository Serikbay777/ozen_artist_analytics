"""
Lyrics FAQ Agent
–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ä–∞–æ–∫–µ –¥–ª—è Apple Music
"""

from langchain_core.prompts import ChatPromptTemplate
from app.agents.LLMManager import LLMManager
import logging
import os

logger = logging.getLogger(__name__)


class LyricsAgent:
    """
    –ê–≥–µ–Ω—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ä–∞–æ–∫–µ/—Ç–µ–∫—Å—Ç–æ–≤ –ø–µ—Å–µ–Ω
    """
    
    def __init__(self):
        self.llm_manager = LLMManager()
        self.knowledge_base = self._load_knowledge_base()
        logger.info("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω LyricsAgent")
    
    def _load_knowledge_base(self) -> str:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ lyrics_guide.txt"""
        base_dir = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
        faq_path = os.path.join(base_dir, 'services', 'faq', 'lyrics_guide.txt')
        
        try:
            with open(faq_path, 'r', encoding='utf-8') as f:
                content = f.read()
            logger.info(f"  ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            return content
        except Exception as e:
            logger.error(f"  ‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: {e}")
            return ""
    
    def answer(self, state: dict) -> dict:
        """
        –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –∫–∞—Ä–∞–æ–∫–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        """
        logger.info("‚Üí LyricsAgent –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å")
        question = state['question']
        
        prompt = ChatPromptTemplate.from_messages([
            ("system", """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∫–∞—Ä–∞–æ–∫–µ –∏ —Ç–µ–∫—Å—Ç–æ–≤ –ø–µ—Å–µ–Ω –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º –ª–µ–π–±–ª–∞ √µzen.

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
{knowledge_base}

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ markdown –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è
4. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
5. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (üé§ üéµ ‚è± üìù –∏ —Ç.–¥.)
6. –î–∞–≤–∞–π –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
7. –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —Ñ–æ—Ä–º–∞—Ç—ã

–ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í:

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ä–∞–æ–∫–µ –¥–ª—è Apple Music?"
–û—Ç–≤–µ—Ç:
"üé§ **–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä–∞–æ–∫–µ –¥–ª—è Apple Music**

**–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞**
üåê –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ lyricpotato.com
üìÅ –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª

**–®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—É–±—Ç–∏—Ç—Ä–æ–≤**
‚è± –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
üìù –§–æ—Ä–º–∞—Ç—ã: TTML, SRC, LRC –∏ DK

**–®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞**
‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –≥–æ—Ç–æ–≤ –∑–∞—Ä–∞–Ω–µ–µ

**–®–∞–≥ 4: –≠–∫—Å–ø–æ—Ä—Ç**
üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ TTML

üîó –°–µ—Ä–≤–∏—Å: lyricpotato.com"

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –Ω—É–∂–µ–Ω –¥–ª—è –∫–∞—Ä–∞–æ–∫–µ?"
–û—Ç–≤–µ—Ç:
"üìù **–§–æ—Ä–º–∞—Ç –¥–ª—è –∫–∞—Ä–∞–æ–∫–µ Apple Music**

–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç: **TTML**

–¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã:
‚Ä¢ SRC
‚Ä¢ LRC
‚Ä¢ DK

üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ lyricpotato.com –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫."
"""),
            ("human", "{question}"),
        ])
        
        response = self.llm_manager.invoke(
            prompt,
            question=question,
            knowledge_base=self.knowledge_base
        )
        
        logger.info(f"  ‚úì –û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω ({len(response)} —Å–∏–º–≤–æ–ª–æ–≤)")
        
        return {
            "answer": response,
            "agent_used": "lyrics"
        }
