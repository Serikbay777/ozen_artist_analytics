"""
Verification FAQ Agent
–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
"""

from langchain_core.prompts import ChatPromptTemplate
from app.agents.LLMManager import LLMManager
import logging
import os

logger = logging.getLogger(__name__)


class VerificationAgent:
    """
    –ê–≥–µ–Ω—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞—Ä—Ç–∏—Å—Ç–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
    """
    
    def __init__(self):
        self.llm_manager = LLMManager()
        self.knowledge_base = self._load_knowledge_base()
        logger.info("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω VerificationAgent")
    
    def _load_knowledge_base(self) -> str:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ verification.txt"""
        base_dir = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
        faq_path = os.path.join(base_dir, 'services', 'faq', 'verification.txt')
        
        try:
            with open(faq_path, 'r', encoding='utf-8') as f:
                content = f.read()
            logger.info(f"  ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            return content
        except Exception as e:
            logger.error(f"  ‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: {e}")
            return ""
    
    def answer(self, state: dict) -> dict:
        """
        –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        """
        logger.info("‚Üí VerificationAgent –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å")
        question = state['question']
        
        prompt = ChatPromptTemplate.from_messages([
            ("system", """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞—Ä—Ç–∏—Å—Ç–æ–≤ –Ω–∞ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö –ª–µ–π–±–ª–∞ √µzen.

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
{knowledge_base}

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ markdown –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è
4. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
5. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (‚úÖ üì± üìß ‚è≥ –∏ —Ç.–¥.)
6. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É - –¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
7. –ï—Å–ª–∏ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å - –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º

–î–û–°–¢–£–ü–ù–´–ï –ü–õ–ê–¢–§–û–†–ú–´:
- Apple Music for Artists
- Spotify for Artists  
- BandLink x –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∞
- VK Studio

–ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í:

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ Spotify?"
–û—Ç–≤–µ—Ç:
"üéµ **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ Spotify for Artists**

**–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**
‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç Spotify (–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ spotify.com)

**–®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**
üì± –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ artists.spotify.com –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
üîë –í–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º Spotify
..."

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏?"
–û—Ç–≤–µ—Ç:
"üìÑ **–î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏**

–î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è:
- –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏
- –î–æ–∫—É–º–µ–Ω—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –ø—Ä–∞–≤–æ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º (–∫–æ–Ω—Ç—Ä–∞–∫—Ç/–¥–æ–≥–æ–≤–æ—Ä)
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email

‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π."
"""),
            ("human", "{question}"),
        ])
        
        response = self.llm_manager.invoke(
            prompt,
            question=question,
            knowledge_base=self.knowledge_base
        )
        
        logger.info(f"  ‚úì –û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω ({len(response)} —Å–∏–º–≤–æ–ª–æ–≤)")
        
        return {
            "answer": response,
            "agent_used": "verification"
        }
