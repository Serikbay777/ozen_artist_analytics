"""
Release Cover FAQ Agent
–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Ñ–æ—Ç–æ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
"""

from langchain_core.prompts import ChatPromptTemplate
from app.agents.LLMManager import LLMManager
import logging
import os

logger = logging.getLogger(__name__)


class ReleaseCoverAgent:
    """
    –ê–≥–µ–Ω—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Ñ–æ—Ç–æ –¥–ª—è —Ä–µ–ª–∏–∑–æ–≤
    """
    
    def __init__(self):
        self.llm_manager = LLMManager()
        self.knowledge_base = self._load_knowledge_base()
        logger.info("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ReleaseCoverAgent")
    
    def _load_knowledge_base(self) -> str:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ release_cover.txt"""
        base_dir = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
        faq_path = os.path.join(base_dir, 'services', 'faq', 'release_cover.txt')
        
        try:
            with open(faq_path, 'r', encoding='utf-8') as f:
                content = f.read()
            logger.info(f"  ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            return content
        except Exception as e:
            logger.error(f"  ‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: {e}")
            return ""
    
    def answer(self, state: dict) -> dict:
        """
        –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Ñ–æ—Ç–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        """
        logger.info("‚Üí ReleaseCoverAgent –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å")
        question = state['question']
        
        prompt = ChatPromptTemplate.from_messages([
            ("system", """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∫ –æ–±–ª–æ–∂–∫–∞–º –∏ —Ñ–æ—Ç–æ –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º –ª–µ–π–±–ª–∞ √µzen.

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
{knowledge_base}

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ markdown –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è
4. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º - —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
5. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (üìê üì± üíª üñº –∏ —Ç.–¥.)
6. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É - –¥–∞–π —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –Ω–µ—ë
7. –ï—Å–ª–∏ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å - –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º

–î–û–°–¢–£–ü–ù–´–ï –ü–õ–ê–¢–§–û–†–ú–´:
- Apple Music
- Spotify (–∞–≤–∞—Ç–∞—Ä–∫–∞ –∏ —à–∞–ø–∫–∞)
- Yandex Music
- Deezer
- VK –ú—É–∑—ã–∫–∞
- YouTube Music/Topic
- ZVUK
- Amazon Music
- Musixmatch
- Genius
- YouTube

–ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í:

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –æ–±–ª–æ–∂–∫–∏ –¥–ª—è Spotify?"
–û—Ç–≤–µ—Ç:
"üéµ **–†–∞–∑–º–µ—Ä—ã –¥–ª—è Spotify**

**–ê–≤–∞—Ç–∞—Ä–∫–∞:**
üìê 750 x 750 –ø–∏–∫—Å–µ–ª–µ–π

**–®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è:**
üìê 2660 x 1140 –ø–∏–∫—Å–µ–ª–µ–π"

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ç–æ –¥–ª—è —Ä–µ–ª–∏–∑–∞?"
–û—Ç–≤–µ—Ç:
"üñº **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ç–æ –¥–ª—è —Ä–µ–ª–∏–∑–æ–≤**

üìê **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:**
‚Ä¢ Apple Music: 2400 x 2400
‚Ä¢ Spotify: 750 x 750 (–∞–≤–∞—Ç–∞—Ä–∫–∞)
‚Ä¢ Yandex Music: 1000 x 1345

‚ö†Ô∏è **–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**
‚Ä¢ –ë–µ–∑ —Ä–∞–º–æ–∫ –∏ –Ω–∞–¥–ø–∏—Å–µ–π
‚Ä¢ –ë–µ–∑ –æ—Ä—É–∂–∏—è, –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—ã—Ö –∂–µ—Å—Ç–æ–≤
‚Ä¢ –ë–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç –∏ –∞–ª–∫–æ–≥–æ–ª—è
‚Ä¢ –î–ª—è VK –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π —Ñ–æ–Ω

üí° –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ç–æ —Å –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ—Å–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º."
"""),
            ("human", "{question}"),
        ])
        
        response = self.llm_manager.invoke(
            prompt,
            question=question,
            knowledge_base=self.knowledge_base
        )
        
        logger.info(f"  ‚úì –û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω ({len(response)} —Å–∏–º–≤–æ–ª–æ–≤)")
        
        return {
            "answer": response,
            "agent_used": "release_cover"
        }
